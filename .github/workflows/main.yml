name: PixelPlay

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      debug:
        description: "Show expanded src contents"
        required: false
        default: "false"

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Workspace debug (top-level)
        run: |
          echo "Workspace top-level:"
          ls -la || true

      - name: Unzip any attached source ZIP (if present)
        run: |
          set -euo pipefail
          mkdir -p src
          # Find any zip attached at repo root (generic)
          ZIP=$(ls -1 *.zip 2>/dev/null | head -n1 || true)
          if [ -n "$ZIP" ]; then
            echo "Found zip: $ZIP"
            unzip -q "$ZIP" -d src
            echo "Extraction complete. Top-level of src:"
            ls -la src || true
          else
            echo "No top-level zip found; ensure sources are in repo or placed under src/"
            echo "Top-level of src (may already contain project files):"
            ls -la src || true
          fi

      - name: Inspect src (debug)
        if: ${{ github.event.inputs.debug == 'true' || github.event_name == 'workflow_dispatch' }}
        run: ls -R src || true

      - name: Set up common runtimes
        run: |
          set -euo pipefail
          echo "Ensuring JDK 17 is available"
          sudo apt-get update -y
          sudo apt-get install -y openjdk-17-jdk-headless || true
          node --version || (sudo apt-get install -y nodejs npm || true)
          python3 --version || sudo apt-get install -y python3
          pip3 --version || sudo apt-get install -y python3-pip

      - name: Cache Gradle directories (optional - speeds up builds)
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}-${{ hashFiles('**/build.gradle*', '**/build.gradle.kts') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build (auto-detect project type, write build.log to workspace)
        id: build
        run: |
          set -euo pipefail
          BUILD_LOG="$GITHUB_WORKSPACE/build.log"
          : > "$BUILD_LOG"
          echo "Build log will be written to: $BUILD_LOG"

          # Search for common project roots under src (maxdepth increased to handle nested zips)
          PROJECT_DIR=""
          PROJECT_DIR=$(find src -maxdepth 8 -type f -name 'settings.gradle*' -printf '%h\n' | head -n1 || true)
          PROJECT_DIR=${PROJECT_DIR:-}
          if [ -z "$PROJECT_DIR" ]; then
            PROJECT_DIR=$(find src -maxdepth 8 -type f -name 'build.gradle*' -printf '%h\n' | head -n1 || true)
          fi
          if [ -z "$PROJECT_DIR" ]; then
            PROJECT_DIR=$(find src -maxdepth 8 -type f -name 'pom.xml' -printf '%h\n' | head -n1 || true)
          fi
          if [ -z "$PROJECT_DIR" ]; then
            PROJECT_DIR=$(find src -maxdepth 8 -type f -name 'package.json' -printf '%h\n' | head -n1 || true)
          fi
          if [ -z "$PROJECT_DIR" ]; then
            PROJECT_DIR=$(find src -maxdepth 8 -type f -name 'pyproject.toml' -o -name 'setup.py' -printf '%h\n' | head -n1 || true)
          fi
          if [ -z "$PROJECT_DIR" ]; then
            PROJECT_DIR=$(find src -maxdepth 8 -type f -name '*.csproj' -printf '%h\n' | head -n1 || true)
          fi

          if [ -z "$PROJECT_DIR" ]; then
            echo "No known project files found under src; skipping build, but will look for artifacts produced elsewhere." | tee "$BUILD_LOG"
            echo "build_succeeded=false" >> "$GITHUB_OUTPUT" || true
            echo "project_dir=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found project directory: $PROJECT_DIR" | tee -a "$BUILD_LOG"
          cd "$PROJECT_DIR"
          echo "Working directory: $(pwd)" | tee -a "$BUILD_LOG"

          BUILD_EXIT=0
          # Detect build system and run appropriate build command (best-effort)
          if [ -f ./gradlew ]; then
            chmod +x ./gradlew
            echo "Using Gradle wrapper (./gradlew)" | tee -a "$BUILD_LOG"
            ./gradlew clean assembleRelease --no-daemon --stacktrace --warning-mode all >> "$BUILD_LOG" 2>&1 || BUILD_EXIT=$?
          elif ls build.gradle* 1> /dev/null 2>&1 || ls settings.gradle* 1> /dev/null 2>&1; then
            echo "Detected Gradle (system) build files" | tee -a "$BUILD_LOG"
            gradle clean assembleRelease --no-daemon --stacktrace --warning-mode all >> "$BUILD_LOG" 2>&1 || BUILD_EXIT=$?
          elif [ -f pom.xml ]; then
            echo "Detected Maven (pom.xml)" | tee -a "$BUILD_LOG"
            mvn -B -DskipTests package >> "$BUILD_LOG" 2>&1 || BUILD_EXIT=$?
          elif [ -f package.json ]; then
            echo "Detected Node.js (package.json)" | tee -a "$BUILD_LOG"
            npm ci >> "$BUILD_LOG" 2>&1 || true
            if jq -e '.scripts.build' package.json >/dev/null 2>&1; then
              npm run build >> "$BUILD_LOG" 2>&1 || BUILD_EXIT=$?
            else
              npm pack >> "$BUILD_LOG" 2>&1 || BUILD_EXIT=$?
            fi
          elif [ -f pyproject.toml ] || [ -f setup.py ]; then
            echo "Detected Python project" | tee -a "$BUILD_LOG"
            pip3 install --upgrade build >> "$BUILD_LOG" 2>&1 || true
            python3 -m build >> "$BUILD_LOG" 2>&1 || BUILD_EXIT=$?
          elif ls *.csproj 1> /dev/null 2>&1; then
            echo "Detected .NET project" | tee -a "$BUILD_LOG"
            dotnet restore >> "$BUILD_LOG" 2>&1 || true
            dotnet build -c Release >> "$BUILD_LOG" 2>&1 || BUILD_EXIT=$?
          else
            echo "Unknown build system; skipping build step" | tee -a "$BUILD_LOG"
            BUILD_EXIT=0
          fi

          BUILD_EXIT=${BUILD_EXIT:-0}
          echo "Build exit code: $BUILD_EXIT" | tee -a "$BUILD_LOG"
          echo "----- tail of build log -----" | tee -a "$BUILD_LOG"
          tail -n 200 "$BUILD_LOG" | tee -a "$BUILD_LOG" || true

          if [ "$BUILD_EXIT" -eq 0 ]; then
            echo "build_succeeded=true" >> "$GITHUB_OUTPUT"
          else
            echo "build_succeeded=false" >> "$GITHUB_OUTPUT"
          fi
          # export the project dir found so downstream steps can reference it
          echo "project_dir=$PROJECT_DIR" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Show build.log head (for quick preview)
        if: always()
        run: |
          echo "---- build.log head ----"
          head -n 400 build.log || true
          echo "---- end head ----"

      - name: Upload build.log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log

      - id: collect_artifacts
        name: Collect build artifacts (generic)
        if: always()
        run: |
          set -euo pipefail
          mkdir -p "$GITHUB_WORKSPACE/dist"
          cd "$GITHUB_WORKSPACE"

          mapfile -t ARTS < <(find src . -maxdepth 8 -type f \( -iname '*.apk' -o -iname '*.aab' -o -iname '*.aar' -o -iname '*.ipa' -o -iname '*.jar' -o -iname '*.war' -o -iname '*.zip' -o -iname '*.tar.gz' -o -iname '*.tgz' -o -iname '*.tar' -o -iname '*.deb' -o -iname '*.rpm' -o -iname '*.exe' -o -iname '*.msi' -o -iname '*.dmg' -o -iname '*.app' -o -iname '*.whl' \) -print 2>/dev/null || true)

          mapfile -t EXTRA < <(find src . -maxdepth 6 -type d \( -iname 'build' -o -iname 'dist' -o -iname 'target' -o -iname 'out' -o -iname 'release' -o -iname 'outputs' -o -iname 'bin' -o -iname 'lib' \) -print 2>/dev/null || true)

          if [ "${#ARTS[@]}" -eq 0 ] && [ "${#EXTRA[@]}" -eq 0 ]; then
            echo "No artifacts found under src or repository tree."
            echo "artifacts_found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          for f in "${ARTS[@]}"; do
            if [ -f "$f" ]; then
              echo "Copying artifact: $f"
              if cp --parents -v "$f" dist/ 2>/dev/null; then
                :
              else
                cp -v "$f" "dist/$(basename "$f")"
              fi
            fi
          done

          for d in "${EXTRA[@]}"; do
            if [ -d "$d" ]; then
              echo "Copying directory tree: $d"
              rsync -a --relative "$d/" dist/ || cp -r "$d"/* dist/ || true
            fi
          done

          if [ "$(find dist -type f | wc -l)" -eq 0 ]; then
            echo "No files were copied into dist despite matches; listing repo for debug:"
            ls -R src || true
            echo "artifacts_found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Artifacts copied into dist:"
          find dist -maxdepth 3 -type f -printf '%s %p\n' | sort -nr | head -n 200 || true
          echo "artifacts_found=true" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: List dist folder (debug)
        if: always()
        run: |
          echo "Contents of dist (top 200 lines):"
          find dist -maxdepth 4 -type f -print | sed -n '1,200p' || true

      - name: Create PixelPlay-master.zip (contains dist if present, else project dir, else src)
        if: always()
        run: |
          set -euo pipefail
          ZIP_PATH="$GITHUB_WORKSPACE/PixelPlay-master.zip"
          rm -f "$ZIP_PATH"
          echo "Will create PixelPlay-master.zip at $ZIP_PATH"

          # Use dist if it has files
          if [ -d "$GITHUB_WORKSPACE/dist" ] && [ "$(find "$GITHUB_WORKSPACE/dist" -type f | wc -l)" -gt 0 ]; then
            echo "Zipping contents of dist into PixelPlay-master.zip"
            (cd "$GITHUB_WORKSPACE/dist" && zip -r "$ZIP_PATH" .) || true
          # else use detected project directory from build step
          elif [ -n "${{ steps.build.outputs.project_dir }}" ] && [ -d "${{ steps.build.outputs.project_dir }}" ] && [ "$(find "${{ steps.build.outputs.project_dir }}" -type f | wc -l)" -gt 0 ]; then
            echo "Zipping project directory (${ { steps.build.outputs.project_dir }}) into PixelPlay-master.zip"
            (cd "${{ steps.build.outputs.project_dir }}" && zip -r "$ZIP_PATH" .) || true
          # else fallback to zipping src
          elif [ -d "$GITHUB_WORKSPACE/src" ] && [ "$(find "$GITHUB_WORKSPACE/src" -type f | wc -l)" -gt 0 ]; then
            echo "Zipping src into PixelPlay-master.zip"
            (cd "$GITHUB_WORKSPACE/src" && zip -r "$ZIP_PATH" .) || true
          else
            echo "No files detected to include; creating small zip with README"
            mkdir -p tmpzip
            printf "No built artifacts or source found to include in PixelPlay-master.zip\n" > tmpzip/README.txt
            (cd tmpzip && zip -r "$ZIP_PATH" .) || true
            rm -rf tmpzip
          fi

          if [ -f "$ZIP_PATH" ]; then
            echo "Created zip:"
            ls -lh "$ZIP_PATH" || true
            echo "zip_path=PixelPlay-master.zip" >> "$GITHUB_OUTPUT"
            echo "pixelplay_zip_created=true" >> "$GITHUB_OUTPUT"
          else
            echo "Failed to create PixelPlay-master.zip" >&2
            echo "pixelplay_zip_created=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi
        shell: bash

      - name: Upload PixelPlay-master.zip artifact
        if: steps.Create_PixelPlay-master_zip.outputs.pixelplay_zip_created == 'true' || steps.create_pixelplay_master_zip.outputs.pixelplay_zip_created == 'true' || always()
        uses: actions/upload-artifact@v4
        with:
          name: PixelPlay-master.zip
          path: PixelPlay-master.zip

      - name: Done
        run: |
          echo "Workflow complete. PixelPlay-master.zip should be attached as an artifact if it was created."
