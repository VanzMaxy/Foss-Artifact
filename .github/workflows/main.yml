name: Build Android APK (Auto-Detect)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          # We REMOVED 'cache: gradle' to prevent the "No file matched" error.
          # The build step below handles caching/setup more gracefully.

      - name: Build APK (Auto-Detect Project Root)
        id: build
        run: |
          set -e
          echo "Searching for project root..."
          
          # 1. Search for settings.gradle or build.gradle to find the project root
          # We look up to 4 levels deep to find where the android project is.
          PROJECT_DIR=$(find . -maxdepth 4 -not -path '*/.*' -type f -name 'settings.gradle*' -printf '%h\n' | head -n1)
          
          if [ -z "$PROJECT_DIR" ]; then
            PROJECT_DIR=$(find . -maxdepth 4 -not -path '*/.*' -type f \( -name 'build.gradle' -o -name 'build.gradle.kts' \) -printf '%h\n' | head -n1)
          fi

          if [ -z "$PROJECT_DIR" ]; then
            echo "Error: Could not find settings.gradle or build.gradle. Is the code in this repo?"
            exit 1
          fi

          echo "Found project in: $PROJECT_DIR"
          cd "$PROJECT_DIR"

          # 2. Check for gradlew wrapper or fall back to system gradle
          if [ -f "./gradlew" ]; then
            echo "ðŸ”§ Found gradlew wrapper. Making executable..."
            chmod +x ./gradlew
            ./gradlew clean assembleDebug --no-daemon --stacktrace
          else
            echo "No gradlew found. Falling back to system gradle..."
            gradle clean assembleDebug --no-daemon --stacktrace
          fi

      - name: Find and Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Debug-APK
          # This pattern searches for any .apk file created in the workspace
          path: '
          **/*.apk'
