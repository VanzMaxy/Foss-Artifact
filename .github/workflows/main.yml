name: Build Android APK (Debug Mode)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # STEP 1: DEBUGGING - See exactly what files are on the server
      - name: List Files (Debug)
        run: |
          echo "Current directory: $(pwd)"
          echo "----------------------------------------"
          echo "Listing all files in repository:"
          find . -maxdepth 4 -not -path '*/.*'
          echo "----------------------------------------"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # STEP 2: BUILD - Smart detect using your specific path info
      - name: Build APK
        id: build
        run: |
          set -e

          # 1. Try to find the folder specifically named "PixelPlay-master" first
          #    or fall back to finding where settings.gradle is.
          echo "Looking for project root..."
          
          if [ -d "PixelPlay-master" ]; then
             PROJECT_ROOT="PixelPlay-master"
             echo "Found explicit 'PixelPlay-master' folder."
          else
             # Find any folder containing settings.gradle or build.gradle (up to depth 3)
             PROJECT_ROOT=$(find . -maxdepth 3 -name settings.gradle* -o -name build.gradle.kts | head -n 1 | xargs dirname)
          fi

          if [ -z "$PROJECT_ROOT" ] || [ "$PROJECT_ROOT" == "." ]; then
             echo "Could not find subfolder, assuming root directory."
             PROJECT_ROOT="."
          fi

          echo "Project Root identified as: $PROJECT_ROOT"
          cd "$PROJECT_ROOT"

          # 2. Make Gradlew Executable and Build
          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            echo "Building with Gradle Wrapper..."
            ./gradlew assembleDebug --stacktrace
          else
            echo "No gradlew found in $PROJECT_ROOT. Using system gradle..."
            gradle assembleDebug --stacktrace
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Debug-APK
          # Search everywhere for the APK
          path:
          "PixelPlay-master/app" 
