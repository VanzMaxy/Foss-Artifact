name: PixelPlay

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      debug:
        description: "Show src contents (no additional uploads)"
        required: false
        default: "false"

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository (shallow to save bandwidth)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Unzip any attached source ZIP (if present)
        run: |
          set -euo pipefail
          mkdir -p src
          ZIP=$(ls -1 *.zip 2>/dev/null | head -n1 || true)
          if [ -n "$ZIP" ]; then
            echo "Found zip: $ZIP (extracting to src/)"
            unzip -q "$ZIP" -d src
          else
            echo "No top-level zip found; using repo files or src/ directory."
          fi

      - name: Inspect src (debug)
        if: ${{ github.event.inputs.debug == 'true' }}
        run: ls -R src || true

      - name: Set up Java (Temurin 17) — required for Android/Gradle builds
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build (Gradle/Maven/Node best-effort; logs to stdout only)
        id: build
        run: |
          set -euo pipefail
          PROJECT_DIR=""
          # prefer Gradle project markers first
          PROJECT_DIR=$(find src -maxdepth 8 -type f -name 'settings.gradle*' -printf '%h\n' | head -n1 || true)
          PROJECT_DIR=${PROJECT_DIR:-}
          if [ -z "$PROJECT_DIR" ]; then
            PROJECT_DIR=$(find src -maxdepth 8 -type f -name 'build.gradle*' -printf '%h\n' | head -n1 || true)
          fi
          # fallback to module files for other ecosystems
          if [ -z "$PROJECT_DIR" ]; then
            PROJECT_DIR=$(find src -maxdepth 8 -type f -name 'pom.xml' -printf '%h\n' | head -n1 || true)
          fi
          if [ -z "$PROJECT_DIR" ]; then
            PROJECT_DIR=$(find src -maxdepth 8 -type f -name 'package.json' -printf '%h\n' | head -n1 || true)
          fi

          if [ -z "$PROJECT_DIR" ]; then
            echo "No known project files found under src — skipping build."
            echo "build_succeeded=false" >> "$GITHUB_OUTPUT" || true
            echo "project_dir=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found project directory: $PROJECT_DIR"
          cd "$PROJECT_DIR"
          echo "Working directory: $(pwd)"

          BUILD_EXIT=0
          # Gradle
          if [ -f ./gradlew ]; then
            chmod +x ./gradlew
            echo "Running Gradle wrapper..."
            ./gradlew clean assembleRelease --no-daemon --stacktrace --warning-mode all || BUILD_EXIT=$?
          elif ls build.gradle* 1> /dev/null 2>&1 || ls settings.gradle* 1> /dev/null 2>&1; then
            echo "Running system Gradle..."
            gradle clean assembleRelease --no-daemon --stacktrace --warning-mode all || BUILD_EXIT=$?
          # Maven
          elif [ -f pom.xml ]; then
            echo "Running Maven..."
            mvn -B -DskipTests package || BUILD_EXIT=$?
          # Node (best-effort) - may increase run time if present
          elif [ -f package.json ]; then
            echo "Running npm build (if present)..."
            npm ci || true
            if jq -e '.scripts.build' package.json >/dev/null 2>&1; then
              npm run build || BUILD_EXIT=$?
            else
              npm pack || BUILD_EXIT=$?
            fi
          else
            echo "Unknown build system; skipping build step."
          fi

          BUILD_EXIT=${BUILD_EXIT:-0}
          echo "build_exit_code=$BUILD_EXIT" >> "$GITHUB_OUTPUT"
          if [ "$BUILD_EXIT" -eq 0 ]; then
            echo "build_succeeded=true" >> "$GITHUB_OUTPUT"
          else
            echo "build_succeeded=false" >> "$GITHUB_OUTPUT"
          fi
          echo "project_dir=$(pwd)" >> "$GITHUB_OUTPUT"
        shell: bash

      - id: pick_apk
        name: Pick one APK (arm64 preferred, second-newest when available)
        run: |
          set -euo pipefail
          # Search common locations for APKs (repo root, src, and build outputs under project_dir)
          PROJECT_DIR="${{ steps.build.outputs.project_dir }}"
          mapfile -t APKS < <(find src . -maxdepth 8 -type f -iname '*.apk' -print 2>/dev/null || true)
          if [ -n "$PROJECT_DIR" ] && [ -d "$PROJECT_DIR" ]; then
            while IFS= read -r -d $'\0' f; do APKS+=( "$f" ); done < <(find "$PROJECT_DIR" -maxdepth 8 -type f -iname '*.apk' -print0 2>/dev/null || true)
          fi

          if [ "${#APKS[@]}" -eq 0 ]; then
            echo "No APKs found."
            echo "apk_found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Prefer ARM64 candidates (name/path contains arm64-v8a, arm64, aarch64)
          ARM_CAND=()
          for f in "${APKS[@]}"; do
            low=$(echo "$f" | tr '[:upper:]' '[:lower:]')
            if echo "$low" | grep -qE 'arm64-v8a|arm64|aarch64'; then
              ARM_CAND+=( "$f" )
            fi
          done

          if [ "${#ARM_CAND[@]}" -gt 0 ]; then
            CAND=( "${ARM_CAND[@]}" )
          else
            CAND=( "${APKS[@]}" )
          fi

          # Sort candidates by modification time (newest first)
          IFS=$'\n' SORTED=($(for f in "${CAND[@]}"; do printf "%s\t%s\n" "$(stat -c %Y "$f")" "$f"; done | sort -r -n | awk -F $'\t' '{print $2}'))
          # Select second-newest if available, else newest
          if [ "${#SORTED[@]}" -ge 2 ]; then
            PICK="${SORTED[1]}"
          else
            PICK="${SORTED[0]}"
          fi

          echo "Picked APK: $PICK"
          # Copy to workspace with minimal extra metadata; single file only
          OUTNAME="$(basename "$PICK")"
          cp -f "$PICK" "$GITHUB_WORKSPACE/selected.apk"
          echo "apk_path=selected.apk" >> "$GITHUB_OUTPUT"
          echo "apk_found=true" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Upload single selected APK (only this artifact)
        if: steps.pick_apk.outputs.apk_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: PixelPlay-Selected-APK
          path: selected.apk

      - name: Finish
        run: |
          if [ "${{ steps.pick_apk.outputs.apk_found }}" == 'true' ]; then
            echo "Uploaded exactly one APK (selected.apk)."
          else
            echo "No APK uploaded because none were found."
          fi
